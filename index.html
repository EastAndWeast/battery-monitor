<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ğŸ”‹ ç”µæ± ç›‘æ§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text: #eee;
            --text-dim: #888;
            --green: #00d26a;
            --yellow: #ffc107;
            --red: #f44336;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif; 
            background: var(--bg); 
            color: var(--text);
            min-height: 100vh;
            padding: 16px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        
        /* é¡¶éƒ¨ç”µæ± çŠ¶æ€ */
        .battery-hero {
            background: linear-gradient(135deg, var(--accent) 0%, var(--card-bg) 100%);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        .battery-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(233,69,96,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .battery-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            position: relative;
            z-index: 1;
        }
        .battery-body {
            width: 120px;
            height: 50px;
            border: 4px solid var(--text);
            border-radius: 10px;
            position: relative;
            padding: 4px;
        }
        .battery-body::after {
            content: '';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 20px;
            background: var(--text);
            border-radius: 0 4px 4px 0;
        }
        .battery-level {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease, background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .battery-level.low { background: linear-gradient(90deg, #f44336, #ff5722); }
        .battery-level.medium { background: linear-gradient(90deg, #ffc107, #ff9800); }
        .battery-level.high { background: linear-gradient(90deg, #00d26a, #00e676); }
        
        .battery-percent {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }
        .battery-status {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 16px;
            position: relative;
            z-index: 1;
        }
        .status-item {
            text-align: center;
        }
        .status-label { font-size: 12px; color: var(--text-dim); }
        .status-value { font-size: 16px; font-weight: 600; }
        
        /* åŠŸç‡å¡ç‰‡ */
        .power-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .power-title {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        .power-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--highlight);
        }
        .power-unit { font-size: 16px; color: var(--text-dim); }
        
        /* ä¿¡æ¯å¡ç‰‡ */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        .info-card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 16px;
        }
        .info-label { font-size: 12px; color: var(--text-dim); margin-bottom: 4px; }
        .info-value { font-size: 18px; font-weight: 600; }
        
        /* å†å²è®°å½• */
        .history-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .clear-btn {
            background: var(--highlight);
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--accent);
        }
        .history-item:last-child { border-bottom: none; }
        .history-time { font-size: 13px; color: var(--text-dim); }
        .history-data { font-size: 14px; }
        .history-power { color: var(--highlight); font-weight: 600; }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .chart-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .chart-canvas {
            width: 100%;
            height: 150px;
        }
        
        /* åº•éƒ¨ */
        .footer {
            text-align: center;
            color: var(--text-dim);
            font-size: 12px;
            padding: 16px;
        }
        
        .charging { color: var(--green); }
        .discharging { color: var(--highlight); }
        
        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: var(--text-dim);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="battery-hero">
            <div class="battery-visual">
                <div class="battery-body">
                    <div class="battery-level high" id="batteryLevel" style="width: 50%">50%</div>
                </div>
            </div>
            <div class="battery-percent" id="batteryPercent">--%</div>
            <div class="battery-status">
                <div class="status-item">
                    <div class="status-label">çŠ¶æ€</div>
                    <div class="status-value" id="chargeStatus">--</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ¸©åº¦</div>
                    <div class="status-value" id="batteryTemp">--Â°C</div>
                </div>
                <div class="status-item">
                    <div class="status-label">ç”µå‹</div>
                    <div class="status-value" id="batteryVoltage">--mV</div>
                </div>
            </div>
        </div>
        
        <div class="power-card">
            <div class="power-title">âš¡ å½“å‰åŠŸç‡</div>
            <div class="power-value"><span id="powerValue">--</span><span class="power-unit"> W</span></div>
        </div>
        
        <div class="info-grid">
            <div class="info-card">
                <div class="info-label">ç”µæ± æŠ€æœ¯</div>
                <div class="info-value" id="batteryTechnology">--</div>
            </div>
            <div class="info-card">
                <div class="info-label">ç”µæ± å®¹é‡</div>
                <div class="info-value" id="batteryCapacity">--</div>
            </div>
            <div class="info-card">
                <div class="info-label">å¥åº·çŠ¶æ€</div>
                <div class="info-value" id="batteryHealth">--</div>
            </div>
            <div class="info-card">
                <div class="info-label">æœ€åæ›´æ–°</div>
                <div class="info-value" id="lastUpdate">--</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="section-title">ğŸ“ˆ ç”µé‡å˜åŒ–æ›²çº¿</div>
            <canvas id="chartCanvas" class="chart-canvas"></canvas>
        </div>
        
        <div class="history-section">
            <div class="section-title">
                <span>ğŸ“‹ å†å²è®°å½•</span>
                <button class="clear-btn" onclick="clearHistory()">æ¸…ç©º</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <div class="footer">
            ğŸ”‹ ç”µæ± ç›‘æ§ Â· å®æ—¶åŠŸç‡è®¡ç®— Â· æ•°æ®æœ¬åœ°å­˜å‚¨
        </div>
    </div>

    <script>
        // å­˜å‚¨é”®å
        const STORAGE_KEY = 'battery_history';
        const MAX_HISTORY = 100;
        
        let batteryManager = null;
        let lastBatteryLevel = 0;
        let lastTimestamp = 0;
        
        // åˆå§‹åŒ–
        async function init() {
            if ('getBattery' in navigator) {
                try {
                    batteryManager = await navigator.getBattery();
                    updateBatteryInfo();
                    batteryManager.addEventListener('levelchange', updateBatteryInfo);
                    batteryManager.addEventListener('chargingchange', updateBatteryInfo);
                    batteryManager.addEventListener('chargingtimechange', updateBatteryInfo);
                    batteryManager.addEventListener('dischargingtimechange', updateBatteryInfo);
                } catch (e) {
                    console.log('Battery API error:', e);
                }
            } else {
                document.getElementById('batteryPercent').textContent = 'ä¸æ”¯æŒ';
            }
            
            // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
            setInterval(recordHistory, 10000);
            // åˆå§‹è®°å½•
            setTimeout(recordHistory, 2000);
            
            // åŠ è½½å†å²
            renderHistory();
            renderChart();
        }
        
        function updateBatteryInfo() {
            if (!batteryManager) return;
            
            const level = Math.round(batteryManager.level * 100);
            const charging = batteryManager.charging;
            const chargeTime = batteryManager.chargingTime;
            const dischargeTime = batteryManager.dischargingTime;
            
            // æ›´æ–°ç”µæ± å›¾æ ‡
            const batteryLevel = document.getElementById('batteryLevel');
            const percent = document.getElementById('batteryPercent');
            const status = document.getElementById('chargeStatus');
            
            batteryLevel.style.width = level + '%';
            batteryLevel.textContent = level + '%';
            percent.textContent = level + '%';
            
            // é¢œè‰²
            if (level <= 20) {
                batteryLevel.className = 'battery-level low';
            } else if (level <= 50) {
                batteryLevel.className = 'battery-level medium';
            } else {
                batteryLevel.className = 'battery-level high';
            }
            
            // çŠ¶æ€
            if (charging) {
                status.textContent = 'âš¡ å……ç”µä¸­';
                status.className = 'status-value charging';
            } else {
                status.textContent = 'ğŸ”‹ ä½¿ç”¨ä¸­';
                status.className = 'status-value discharging';
            }
            
            // ç”µæ± ä¿¡æ¯
            document.getElementById('batteryTechnology').textContent = 
                batteryManager.technology || 'Li-ion';
            
            // ç”µå‹ä¼°ç®— (Androidæœ‰æ›´ç²¾ç¡®çš„å€¼ï¼Œè¿™é‡Œç”¨ä¼°ç®—)
            const voltage = Math.round(3.7 + (batteryManager.level * 0.8)) * 1000;
            document.getElementById('batteryVoltage').textContent = voltage + ' mV';
            
            // æ¸©åº¦ (éœ€è¦Android APIï¼Œè¿™é‡Œæ˜¾ç¤ºä¸å¯ç”¨)
            document.getElementById('batteryTemp').textContent = 'éœ€ç³»ç»Ÿæƒé™';
            
            // å®¹é‡
            document.getElementById('batteryCapacity').textContent = 'éœ€ç³»ç»Ÿæƒé™';
            
            // å¥åº·çŠ¶æ€
            document.getElementById('batteryHealth').textContent = 'éœ€ç³»ç»Ÿæƒé™';
            
            // æ›´æ–°ç”µé‡çš„æ—¶é—´
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // è®¡ç®—åŠŸç‡
            calculatePower(level);
            
            lastBatteryLevel = level;
        }
        
        function calculatePower(currentLevel) {
            // åŠŸç‡ = ç”µå‹ Ã— ç”µæµ
            // è¿™é‡Œç”¨ä¼°ç®—æ–¹å¼ï¼šå‡è®¾ç”µå‹4.2Vï¼Œç”µæµæ ¹æ®æ”¾ç”µ/å……ç”µçŠ¶æ€
            // å®é™…éœ€è¦Androidçš„BatteryManager API
            
            const voltage = 3.8; // V
            let current = 0; // A
            
            if (batteryManager && batteryManager.charging) {
                // å……ç”µç”µæµä¼°ç®— (1A-2A)
                current = 1.5;
            } else {
                // æ”¾ç”µç”µæµæ ¹æ®ç”µé‡ä¼°ç®—
                // ç”µé‡è¶Šä½ï¼Œæ”¾ç”µè¶Šå¿«
                current = 0.3 + (currentLevel / 100) * 1.5;
            }
            
            const power = (voltage * current).toFixed(2);
            document.getElementById('powerValue').textContent = power;
        }
        
        function recordHistory() {
            if (!batteryManager) return;
            
            const level = Math.round(batteryManager.level * 100);
            const charging = batteryManager.charging;
            const now = Date.now();
            
            // è·å–å½“å‰åŠŸç‡
            const powerEl = document.getElementById('powerValue');
            const power = parseFloat(powerEl.textContent) || 0;
            
            // è®°å½•æ•°æ®
            const record = {
                time: now,
                level: level,
                charging: charging,
                power: power
            };
            
            // è·å–å†å²
            let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            history.push(record);
            
            // ä¿ç•™æœ€è¿‘100æ¡
            if (history.length > MAX_HISTORY) {
                history = history.slice(-MAX_HISTORY);
            }
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            
            // æ›´æ–°æ˜¾ç¤º
            renderHistory();
            renderChart();
        }
        
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const list = document.getElementById('historyList');
            
            if (history.length === 0) {
                list.innerHTML = '<div class="loading">æš‚æ— è®°å½•</div>';
                return;
            }
            
            // å–æœ€è¿‘20æ¡
            const recent = history.slice(-20).reverse();
            
            let html = '';
            recent.forEach(item => {
                const date = new Date(item.time);
                const timeStr = date.getHours().toString().padStart(2,'0') + ':' + 
                               date.getMinutes().toString().padStart(2,'0');
                const chargeIcon = item.charging ? 'âš¡' : 'ğŸ”‹';
                
                html += `
                    <div class="history-item">
                        <span class="history-time">${timeStr}</span>
                        <span class="history-data">
                            ${chargeIcon} ${item.level}% 
                            <span class="history-power">${item.power}W</span>
                        </span>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        function renderChart() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const canvas = document.getElementById('chartCanvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå¤§å°
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            
            const width = rect.width;
            const height = rect.height;
            
            // æ¸…ç©º
            ctx.clearRect(0, 0, width, height);
            
            if (history.length < 2) {
                ctx.fillStyle = '#888';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('æ•°æ®ä¸è¶³', width/2, height/2);
                return;
            }
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 4; i++) {
                const y = (height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶ç”µé‡æ›²çº¿
            ctx.strokeStyle = '#e94560';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const padding = 20;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            history.forEach((item, i) => {
                const x = padding + (i / (history.length - 1)) * chartWidth;
                const y = padding + chartHeight - (item.level / 100) * chartHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // ç»˜åˆ¶ç‚¹
            history.forEach((item, i) => {
                const x = padding + (i / (history.length - 1)) * chartWidth;
                const y = padding + chartHeight - (item.level / 100) * chartHeight;
                
                ctx.fillStyle = item.charging ? '#00d26a' : '#e94560';
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function clearHistory() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ï¼Ÿ')) {
                localStorage.removeItem(STORAGE_KEY);
                renderHistory();
                renderChart();
            }
        }
        
        // å¯åŠ¨
        init();
    </script>
</body>
</html>
